# Simple and Secure Workflow for Deploying Static Content to GitHub Pages
name: Deploy static content to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  setup_environment:
    name: Setup Project Directory Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Directory Structure
        run: |
          mkdir -p .github/workflows
          mkdir -p src
          mkdir -p dist
          echo "Directory structure created"

      - name: Create Sample Files
        run: |
          echo "<!DOCTYPE html><html lang='en'><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1.0'><title>Skunkworks Academy</title></head><body><h1>Welcome to Skunkworks Academy</h1></body></html>" > index.html
          echo "body { font-family: Arial, sans-serif; }" > src/styles.scss
          echo "console.log('Hello, Skunkworks Academy!');" > src/index.js
          echo "Sample files created"

  install_dependencies:
    name: Install Dependencies
    runs-on: ubuntu-latest
    needs: setup_environment
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Clean NPM Cache
        run: npm cache clean --force

      - name: Install Dependencies
        run: npm install --legacy-peer-deps  # Use legacy-peer-deps to resolve conflicts

  lint_and_test:
    name: Lint and Test Code
    runs-on: ubuntu-latest
    needs: install_dependencies
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Add Node Modules to PATH
        run: echo "::add-path::$(npm bin)"

      - name: Run Linting
        run: npm run lint
        continue-on-error: true  # Allow workflow to proceed even if linting fails
        env:
          CI: true  # Ensure that linting runs in CI mode

      - name: Run Style Linting
        run: npm run lint:styles
        continue-on-error: true  # Allow workflow to proceed even if style linting fails
        env:
          CI: true  # Ensure that style linting runs in CI mode

      - name: Run Tests
        run: npm test
        continue-on-error: true  # Allow workflow to proceed even if tests fail
        env:
          CI: true  # Ensure that tests run in CI mode

      - name: Upload Linting and Test Results
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: lint-test-report
          path: ./lint-test-report/

  build_and_deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: lint_and_test
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Dependencies
        run: npm install --legacy-peer-deps  # Use legacy-peer-deps to resolve conflicts

      - name: Build Static Site
        run: npm run build
        continue-on-error: false  # Stop the workflow if the build fails

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'dist'  # Assuming parcel outputs to the 'dist' folder

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Notify Deployment Success
        if: success()
        uses: microsoft365/send-mail@v1.0
        with:
          client-id: ${{ secrets.MS_CLIENT_ID }}
          tenant-id: ${{ secrets.MS_TENANT_ID }}
          client-secret: ${{ secrets.MS_CLIENT_SECRET }}
          subject: "GitHub Pages Deployment Successful"
          body: "The deployment of static content to GitHub Pages was successful. You can view the site at ${{ steps.deployment.outputs.page_url }}."
          from: "noreply@skunkworks.africa"
          to: "info@skunkworks.africa"
          reply-to: "noreply@skunkworks.africa"

      - name: Notify Deployment Failure
        if: failure()
        uses: microsoft365/send-mail@v1.0
        with:
          client-id: ${{ secrets.MS_CLIENT_ID }}
          tenant-id: ${{ secrets.MS_TENANT_ID }}
          client-secret: ${{ secrets.MS_CLIENT_SECRET }}
          subject: "GitHub Pages Deployment Failed"
          body: "The deployment of static content to GitHub Pages has failed. Please check the workflow logs for more details."
          from: "noreply@skunkworks.africa"
          to: "info@skunkworks.africa"
          reply-to: "noreply@skunkworks.africa"
