# Simple and Secure Workflow for Deploying Static Content to GitHub Pages
name: Deploy static content to Pages

on:
  push:
    branches: ["main"]
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  setup_environment:
    name: Setup Project Directory Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create Directory Structure
        run: |
          mkdir -p .github/workflows
          mkdir -p src
          mkdir -p dist
          echo "Directory structure created"

      - name: Create Sample Files
        run: |
          echo "<!DOCTYPE html><html lang='en'><head><meta charset='UTF-8'><meta name='viewport' content='width=device-width, initial-scale=1.0'><title>Skunkworks Academy</title></head><body><h1>Welcome to Skunkworks Academy</h1></body></html>" > index.html
          echo "@import '~carbon-components/scss/globals/scss/styles.scss'; body { font-family: Arial, sans-serif; }" > src/styles.scss
          echo "import 'carbon-components/js/globals/scss/globals'; console.log('Hello, Skunkworks Academy!');" > src/index.js
          echo "Sample files created"

      - name: Ensure Proper Permissions
        run: |
          sudo chown -R $USER:$USER .
          chmod -R 755 .

  install_dependencies:
    name: Install Dependencies
    runs-on: ubuntu-latest
    needs: setup_environment
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Cache Node Modules
        uses: actions/cache@v3
        with:
          path: ~/.npm
          key: ${{ runner.os }}-node-${{ hashFiles('package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-node-

      - name: Clean NPM Cache
        run: npm cache clean --force

      - name: Install Dependencies
        run: npm install --legacy-peer-deps  # Use legacy-peer-deps to resolve conflicts

  lint_and_test:
    name: Lint and Test Code
    runs-on: ubuntu-latest
    needs: install_dependencies
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Add Node Modules to PATH
        run: echo "PATH=$(npm bin):\$PATH" >> $GITHUB_ENV  # Corrected to properly append the npm bin directory to PATH

      - name: Run Linting
        run: npm run lint
        continue-on-error: true
        env:
          CI: ${{ env.CI }}

      - name: Run Style Linting
        run: npm run lint:styles
        continue-on-error: true
        env:
          CI: ${{ env.CI }}

      - name: Run Tests
        run: npm test
        continue-on-error: true
        env:
          CI: ${{ env.CI }}

      - name: Upload Linting and Test Results
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: lint-test-report
          path: ./lint-test-report/

  build_and_deploy:
    name: Build and Deploy
    runs-on: ubuntu-latest
    needs: lint_and_test
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Install Dependencies
        run: npm install --legacy-peer-deps

      - name: Build Static Site
        run: npm run build
        continue-on-error: false  # Stop the workflow if the build fails

      - name: Upload Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'dist'

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  post_cleanup:
    name: Post-flow Cleanup and Directory Check
    runs-on: ubuntu-latest
    needs: build_and_deploy
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Remove Unwanted Files and Directories
        run: |
          echo "Directories and files before cleanup:"
          ls -la

          rm -rf node_modules/
          rm -rf .cache/
          rm -rf dist/

          echo "Directories and files after cleanup:"
          ls -la

      - name: Verify Required Directories and Files
        run: |
          REQUIRED_ITEMS=(".github/" "src/" "index.html" "package.json" "package-lock.json" "yarn.lock")
          for item in "${REQUIRED_ITEMS[@]}"; do
            if [ ! -e "$item" ]; then
              echo "Required item $item is missing!"
              exit 1
            fi
          done
          echo "All required items are present."

      - name: Notify Cleanup Success
        run: echo "Cleanup and verification completed successfully."

      - name: Notify Deployment Success
        if: success()
        uses: microsoft365/send-mail@v1.0
        with:
          client-id: ${{ secrets.MS_CLIENT_ID }}
          tenant-id: ${{ secrets.MS_TENANT_ID }}
          client-secret: ${{ secrets.MS_CLIENT_SECRET }}
          subject: "GitHub Pages Deployment and Cleanup Successful"
          body: "The deployment of static content to GitHub Pages and post-flow cleanup were successful."
          from: "noreply@skunkworks.africa"
          to: "info@skunkworks.africa"
          reply-to: "noreply@skunkworks.africa"

      - name: Notify Deployment Failure
        if: failure()
        uses: microsoft365/send-mail@v1.0
        with:
          client-id: ${{ secrets.MS_CLIENT_ID }}
          tenant-id: ${{ secrets.MS_TENANT_ID }}
          client-secret: ${{ secrets.MS_CLIENT_SECRET }}
          subject: "GitHub Pages Deployment Failed"
          body: "The deployment of static content to GitHub Pages has failed. Please check the workflow logs for more details."
          from: "noreply@skunkworks.africa"
          to: "info@skunkworks.africa"
          reply-to: "noreply@skunkworks.africa"
